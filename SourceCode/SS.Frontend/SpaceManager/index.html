<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Manager</title>
    <script src="pages/Registration.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <script src="node_modules/htmx.org/dist/htmx.js"></script>
    <link rel="stylesheet" href="pages/SpaceManager.css">
    <link rel="icon" type="image/x-icon" href="pages/favicon.ico">
</head>
<body class="background-image">
    <nav>
        <div class="logo-container">
            <img src="pages/astroSurf.png" alt="Company Logo" width="160" height="150" style="padding-left: 5px;">
            <img src="pages/ssName.png" alt="Company Name" width="440" height="80" style="padding: 25px 15px 0px 0px;">
        </div>
        <div class="nav-items">
            <div class="nav-item" id="navSpaceManager" onclick="showView('spaceManager')">Space Manager</div>
            <div class="nav-item" id="navAbout" onclick="showView('about')">About</div>
            <div class="nav-item" id="navLogin" onclick="showView('login')">Logout</div>
        </div>
    </nav>

    <!-- Space Manager -->
    <button class="accordion">Upload Space</button>
    <div class="form-container" style="display:none;">
        <form id="accountCreationForm">
            <div class="spaceRow">
                <input type="file" id="imageUpload" name="imageUpload" accept="image/*">
                <small>Max file size: 5MB</small>
                <input type="text" id="floorPlanName" name="floorPlanName" placeholder="Floor Plan Name" required><br/>
                <input type="hidden" id="imageBase64" name="imageBase64">
            </div>
            <div id="imagePreviewContainer"></div><br>
            <button type="button" id="addSpace">Add Space ID</button><br/>
            <div id="spacesContainer">
                <div class="spaceRow">
                    <input type="text" class="spaceID" name="spaceID[]" placeholder="Space ID">
                    <input type="text" class="timeLimit" name="timeLimit[]" placeholder="Time Limit">
                </div>
            </div>

            <button id="postSpace" type="submit">Create Space</button>
            <button id="loadRequestsButton" type="button">Load Requests</button>
            <ul id="recoveryRequestsList"></ul>
        </form>
    </div>
           
    </div>
    <button class="accordion">Modify Space</button>
    <div class="form-container" style="display:none;">
        <form id="modifySpaceForm">
            <h3>Warning: CANNOT Modify Space if an existing Reservation Associated Exists</h3>
            <div class="spaceRowModify">
                <input type="text" id="modifyFloorPlanName" name="floorPlanName" placeholder="Floor Plan Name"><br/>
                <input type="file" id="replaceImage" name="replaceImage" accept="image/*">
                <button id="modifyImage" type="button" class = "btn btn-modify">Replace Floor Plan Image - Max file size: 5MB</button>
                <input type="hidden" id="modifyImageBase64" name="modifyImageBase64">
                <button id="deleteFloor" type="button" class="btn btn-danger">Delete Floor</button>
            </div>
            <div id="modifyImagePreviewContainer"></div><br>
            <button type="button" id="addSpaceModify"  class="btn btn-add-space">Add Space ID</button><br/>
            <div id="spacesModificationContainer">
                <div class="spaceRowModify">
                    <input type="text" class="modifySpaceID" name="spaceID[]" placeholder="Space ID">
                    <input type="text" class="modifyTimeLimit" name="modifytimeLimit[]" placeholder="Modify Time Limit">
                    <button id="deleteSpace" type="button" class = "btn btn-danger">Delete Space</button>
                </div>
            </div>

            <button id="modifyTimeLimits" type="submit"  class="btn btn-modify">Modify Time Limits</button>
            <!-- <button id="loadRequestsButton">Load Requests</button> -->
            <!-- <ul id="recoveryRequestsList"></ul> -->
        </form>
    </div>
    


    <script>
        document.getElementById('replaceImage').addEventListener('change', function(event) {
            var fileModify = event.target.files[0];

            if (!fileModify) {
                alert('No file selected.');
                return;
            }

            if (fileModify.size > 5242880) { // 5MB in bytes
                alert('The file is too large. Please select a file smaller than 5MB.');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                // Display image preview
                var imagePreviewContainer = document.getElementById('modifyImagePreviewContainer');
                imagePreviewContainer.innerHTML = '';
                var img = document.createElement('img');
                img.src = e.target.result; // Display the image preview
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                imagePreviewContainer.appendChild(img);

                // Set the hidden input field's value to the base64 string
                var base64String = e.target.result.split(',')[1]; // Extract base64 data
                document.getElementById('modifyImageBase64').value = base64String; // Assign to hidden input
            };

            reader.readAsDataURL(fileModify);
        });


        document.getElementById('imageUpload').addEventListener('change', function(event) {
            var file = event.target.files[0];

            if (!file) {
                alert('No file selected.');
                return;
            }

            if (file.size > 5242880) { // 5MB in bytes
                alert('The file is too large. Please select a file smaller than 5MB.');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                // Display image preview
                var imagePreviewContainer = document.getElementById('imagePreviewContainer');
                imagePreviewContainer.innerHTML = '';
                var img = document.createElement('img');
                img.src = e.target.result; // Display the image preview
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                imagePreviewContainer.appendChild(img);

                // Set the hidden input field's value to the base64 string
                var base64String = e.target.result.split(',')[1]; // Extract base64 data
                document.getElementById('imageBase64').value = base64String; // Assign to hidden input
            };

            reader.readAsDataURL(file);
        });

        document.getElementById('addSpace').addEventListener('click', function() {
            const container = document.getElementById('spacesContainer');
            const currentSpaces = container.getElementsByClassName('spaceRow').length;

            if (currentSpaces >= 20) {
                alert('You cannot add more than 20 spaces.');
                return; // Stop the function here
            }

            console.log('Button clicked!'); // This should appear in the browser console when the button is clicked.
            const newRow = document.createElement('div');
            newRow.classList.add('spaceRow');
            newRow.innerHTML = `
                <input type="text" class="spaceID" name="spaceID[]" placeholder="Space ID">
                <input type="text" class="timeLimit" name="timeLimit[]" placeholder="Time Limit">
            `;
            container.appendChild(newRow);
        });

        document.getElementById('addSpaceModify').addEventListener('click', function() {
            const container = document.getElementById('spacesModificationContainer');
            const currentModifiedSpaces = container.getElementsByClassName('spaceRowModify').length;

            if (currentModifiedSpaces >= 20) {
                alert('You cannot add more than 20 modified spaces.');
                return; // Stop the function here
            }

            console.log('Button clicked!'); // This should appear in the browser console when the button is clicked.
            const newRow = document.createElement('div');
            newRow.classList.add('spaceRowModify');
            newRow.innerHTML = `
                <input type="text" class="modifySpaceID" name="spaceID[]" placeholder="Space ID">
                <input type="text" class="modifyTimeLimit" name="modifytimeLimit[]" placeholder="Time Limit">
                <button type="button" class="btn btn-danger deleteSpace">Delete Space</button>
            `;
            container.appendChild(newRow);

            // Attach event listener to the newly added delete button for dynamic deletion
            newRow.querySelector('.deleteSpace').addEventListener('click', function() {
                this.closest('.spaceRowModify').remove();
            });
        });

        function collectSpacesAndTimeLimits() {
            let spacesDict = {};
            // Assuming each spaceID input is directly followed by its corresponding timeLimit input
            const spaceIDs = document.querySelectorAll('.spaceID');
            const timeLimits = document.querySelectorAll('.timeLimit');

            spaceIDs.forEach((spaceInput, index) => {
                const spaceID = spaceInput.value;
                const timeLimit = timeLimits[index].value; // Assuming the same index
                if (spaceID && timeLimit) {
                    spacesDict[spaceID] = parseInt(timeLimit);
                }
            });

            return spacesDict;
        }

        function collectSpacesAndTimeLimitsToModify() {
            let spacesDict = {};
            // Assuming each spaceID input is directly followed by its corresponding timeLimit input
            const spaceIDs = document.querySelectorAll('.modifySpaceID');
            const timeLimits = document.querySelectorAll('.modifyTimeLimit');

            spaceIDs.forEach((spaceInput, index) => {
                const spaceID = spaceInput.value;
                const timeLimit = timeLimits[index].value; // Assuming the same index
                if (spaceID && timeLimit) {
                    spacesDict[spaceID] = parseInt(timeLimit);
                }
            });

            return spacesDict;
        }


        var acc = document.getElementsByClassName("accordion");
        var i;

        for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var panel = this.nextElementSibling;
            if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
            } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
            }
        });
         }
    
        $(document).ready(function() {
            $('.accordion').click(function() {
                this.classList.toggle("active");
                var formContainer = $(this).next('.form-container');
                if (formContainer.css('display') === "none") {
                    formContainer.css('display', 'flex'); // Show the form
                } else {
                    formContainer.css('display', 'none'); // Hide the form
                }
            });

            $('#loadRequestsButton').click(function() {
                $.ajax({
                    url: 'http://localhost:8080/api/SpaceManager/createSpace',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        $('#recoveryRequestsList').empty(); 
                        data.forEach(function(request) {
                            var listItem = '<li>Name : ' + request.floorPlanName + ', Spaces : ' + request.spaceList;
                            if(request.resolveDate) {
                                listItem += ', Resolve Date: ' + request.resolveDate;
                            }
                          
                            listItem += '</li>';
                            $('#recoveryRequestsList').append(listItem);
                        });
                    },
                    error: function(error) {
                        console.error(error);
                    }
                });
            });
            $('#accountCreationForm').submit(function(e) {
                e.preventDefault();
                

                var companyFloor = {
                    FloorPlanName: $('#floorPlanName').val(),
                    FloorPlanImage: $('#imageBase64').val(),
                    FloorSpaces: collectSpacesAndTimeLimits()
                    
                };
                $.ajax({
                    url: 'http://localhost:8080/api/SpaceManager/postSpace',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(companyFloor),
                    success: function(response) {
                        alert('Space created successfully!');
                        console.log(response); // Log response for debugging
                    },
                    error: function(xhr, status, error) {
                        console.error(xhr.responseText); // Log response text for debugging
                        alert('Error creating space. ' + xhr.responseText);
                    }
                });
            });




            $('#modifySpaceForm').submit(function(e) {
                e.preventDefault();

                var spacesToModify = collectSpacesAndTimeLimitsToModify();
                console.log("Submitting with data:", spacesToModify); // Debug output

                $.ajax({
                    url: 'http://localhost:8080/api/SpaceManager/modifyTimeLimits',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(spacesToModify),
                    success: function(response) {
                        console.log("Response from server:", response); // Debug output
                        alert('Modified Time Limit successfully!');
                    },
                    error: function(xhr, status, error) {
                        var errorMsg = xhr.responseJSON?.message || xhr.statusText;
                        console.error("Error from server:", errorMsg); // Debug output
                        alert('Error Modifying Time Limit: ' + errorMsg);
                    }
                });
            });

            $('#modifyImage').click(function(e) {
                e.preventDefault();
                console.log('Modify image button clicked');

               
                var newFloor = {
                    FloorPlanName: $('#modifyFloorPlanName').val(),
                    NewFloorPlanImage: $('#modifyImageBase64').val()
                };

                $.ajax({
                    url: 'http://localhost:8080/api/SpaceManager/modifyFloorPlan',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(newFloor),
                    success: function(response) {
                        console.log("Response from server:", response); // Debug output
                        alert('Modified Image successfully!');
                    },
                    error: function(xhr, status, error) {
                        var errorMsg = xhr.responseJSON?.message || xhr.statusText;
                        console.error("Error from server:", errorMsg); // Debug output
                        alert('Error Modifying Image: ' + errorMsg);
                    }
                });
            });
            $('#deleteFloor').click(function(e) {
                e.preventDefault();
                console.log('Modify image button clicked');
                var spaceID = $(this).closest('.spaceRowModify').find('.modifySpaceID').val();
                console.log("Space ID to delete:", spaceID);
                
                // Log the spaceID to the console for debugging
                console.log("Space ID to delete:", spaceID);

                $.ajax({
                    url: 'http://localhost:8080/api/SpaceManager/deleteSpace',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ spaceID: spaceID}),
                    success: function(response) {
                        console.log("Response from server:", response); // Debug output
                        alert('Deleted Space successfully!');
                    },
                    error: function(xhr, status, error) {
                        var errorMsg = xhr.responseJSON?.message || xhr.statusText;
                        console.error("Error from server:", errorMsg); // Debug output
                        alert('Error Deleting Space: ' + errorMsg);
                    }
                });
            });

            $('#deleteFloor').click(function(e) {
                e.preventDefault();
                console.log('Delete Floor button clicked');
                var FloorPlanName = $('#modifyFloorPlanName').val();
                console.log("Floor PLan to delete to delete:", FloorPlanName);
                

                $.ajax({
                    url: 'http://localhost:8080/api/SpaceManager/deleteFloor',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ FloorPlanName: FloorPlanName}),
                    success: function(response) {
                        console.log("Response from server:", response); // Debug output
                        alert('Deleted Floor successfully!');
                    },
                    error: function(xhr, status, error) {
                        var errorMsg = xhr.responseJSON?.message || xhr.statusText;
                        console.error("Error from server:", errorMsg); // Debug output
                        alert('Error Deleting Floor: ' + errorMsg);
                    }
                });
            });
        });
    </script>
</div>
<div>
<footer>
    Designed and Developed by the PixelPals Team
</footer>
</body>
</html>

